<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D&D Character Sheet</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.22.0/dist/pdf-lib.min.js"></script>
</head>
<body>
  <div class="controls">
    <button id="generateBtn">Generate New Character</button>
    <button id="downloadBtn">Download as PDF</button>
  </div>

  <div id="preview-container">
    <p id="preview-msg">Character will be generated here.</p>
  </div>

  <script type="module">
    import { PDFDocument, StandardFonts, rgb } from 'https://cdn.jsdelivr.net/npm/pdf-lib@1.22.0/dist/pdf-lib.min.js';

    let currentCharacter = null;

    async function fetchCharacter() {
      try {
        const res = await fetch("http://localhost:3000/api/character");
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        currentCharacter = data;
        document.getElementById('preview-msg').textContent = `Character loaded: ${data.charName}`;
      } catch (err) {
        console.error(err);
        alert('Failed to load character. Make sure API is running.');
      }
    }

    async function downloadPDF() {
      if (!currentCharacter) {
        alert('Generate a character first!');
        return;
      }

      // Fetch blank official 5e sheet PDF (must be hosted or local)
      const pdfUrl = '5e_blank_character_sheet.pdf'; // path to official blank PDF
      const existingPdfBytes = await fetch(pdfUrl).then(res => res.arrayBuffer());

      const pdfDoc = await PDFDocument.load(existingPdfBytes);
      const page = pdfDoc.getPage(0);
      const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

      // Example: write character name at coordinates
      page.drawText(currentCharacter.charName || 'Unnamed Hero', {
        x: 50,
        y: 700,
        size: 14,
        font,
        color: rgb(0, 0, 0)
      });

      // Map other fields to positions (you must tweak coordinates)
      page.drawText(currentCharacter.charClass || '', { x: 50, y: 680, size: 12, font, color: rgb(0,0,0) });
      page.drawText(currentCharacter.charRace || '', { x: 50, y: 660, size: 12, font, color: rgb(0,0,0) });
      page.drawText(currentCharacter.alignment || '', { x: 50, y: 640, size: 12, font, color: rgb(0,0,0) });

      // Example: Ability scores
      const stats = currentCharacter.stats || {};
      const statMods = currentCharacter.statMods || {};
      const statCoordinates = {
        STR: {x: 50, y: 600},
        DEX: {x: 50, y: 580},
        CON: {x: 50, y: 560},
        INT: {x: 50, y: 540},
        WIS: {x: 50, y: 520},
        CHA: {x: 50, y: 500}
      };
      for (const [stat, val] of Object.entries(stats)) {
        const coord = statCoordinates[stat];
        if (coord) {
          page.drawText(`${val} (${statMods[stat] >=0 ? '+' : ''}${statMods[stat] ?? 0})`, {
            x: coord.x,
            y: coord.y,
            size: 12,
            font,
            color: rgb(0,0,0)
          });
        }
      }

      // Generate PDF bytes
      const pdfBytes = await pdfDoc.save();

      // Trigger download
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentCharacter.charName?.replace(/\s+/g,'_') || 'Character'}_Sheet.pdf`;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('generateBtn').addEventListener('click', fetchCharacter);
    document.getElementById('downloadBtn').addEventListener('click', downloadPDF);

    // Auto-fetch on load
    fetchCharacter();
  </script>
</body>
</html>